<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="js/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.css" type="text/css" rel="stylesheet">
        <script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>
        <script src="js/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.js"></script>
         <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBKN_QbuuqENKBxjanKrOGXMym1hI5Z2nw"></script>
        <script>
        
            // Within the bracket, choose a selector - a DOM object, in this case, it is the entire document.This waits for the document to load - an event listener. The function is the event handler.
            $(document).ready(function() {
                $("#btnGetWeather").on("click", function() {

                    var weatherLocation = $("#weatherSearch").val();

                if (weatherLocation != ""){
                    //call the function getWeatherData to get weather
                   getWeatherData(weatherLocation);


                } else {

                   alert("Enter a valid Location");
                }

                });

                getLocation();

            });
            
              // This function makes a call to the api
    function getWeatherData(city){
        var apiKey = "7a2a6d2d24f1f854d75d30e12cfe583a";
        // I changed this wsUrl to be the correct endpoint (I don't know why it was working before
        // According to the docs (http://openweathermap.org/current#name) if searching by name we need
        // to talk to this endpoint. Previously it was (incorrectly)
        // "http://api.openweathermap.org/data/2.5/weather/?q=city=<city>&appid=<apiKey>"
        var wsUrl = "http://api.openweathermap.org/data/2.5/weather?q=";
        wsUrl = wsUrl + city + "&appid="+ apiKey;
        
        // Test it
        console.log(wsUrl);
        
        
        $.getJSON(wsUrl, function(data){
            console.log(data);
            var wr = "Humitidity: " + data.main.humidity + "<br>";
            wr += "Temp: " + data.main.temp;
            $("#weather").html(wr);
            initMap(data.coord.lat, data.coord.lon);
            
            
            if (data.weather[0].main == "Clouds") {
                wr += "<img src='images/clouds-icon.png'>";
            }
            else if (data.weather[0].main == "Rain") {
                wr += "<img src='images/rain-icon.png'>";
            }

            
            
            
            // Print out only the main property from the Object
            console.log(data.main);
        });
    }
    
  
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            console.log("Geolocation is not supported by this browser.");
        }
    }

    function showPosition(position) {
        console.log("Latitude: " + position.coords.latitude);
        console.log("Longitude: " + position.coords.longitude); 
    }
        
    function initMap(lat, lon) {
        
        var coords = {};
        //  ^^^^^^ This needs to be an object {lat: number, lng: number} (see below for more details)
       
        
        // The commented out things won't work unless you actually store the lattitude
        // and longitude values in the current session's local storage (you would have
        // to do that in the "getLocation" function, then access them here.) I've just
        // set this so that the lat/lon we pass in are used
        coords.lat = lat;// parseFloat(sessionStorage.getItem("latitude"));
        coords.lng = lon;// parseFloat(sessionStorage.getItem("longitude"));

        // coords was originally {lat: number, log: number}, which the Google Maps constructor below couldn't understand because
        // lon and lng aren't the same, that's why the map wasn't showing up. I figured that out from
        // looking at the Google Maps API docs here (https://developers.google.com/maps/documentation/javascript/reference#Map)
        // and looking at description of a MapOptions object (https://developers.google.com/maps/documentation/javascript/reference#MapOptions)
        // it says it takes a LatLng object for "center:" here (https://developers.google.com/maps/documentation/javascript/reference#LatLng)
        
        var map = new google.maps.Map(document.getElementById('googleMap'), {zoom: 7, center: coords});
        
        var marker = new google.maps.Marker( {
            position: coords,
            map: map
            
        });
    }
        
    function initializeGoogleMap(lat, lon) {
        
        var mapProp = {
            center:new google.maps.LatLng(lat, lon),
            zoom: 7,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        
        var mapContainer = document.getElementById("googleMap");
        var map =
            new google.maps.Map(
                mapContainer, mapProp);
        
        

    }

        </script>
    </head>
    <body>
        <section id="todayforecast" data-role="page">
            <div data-role="header">
                <h1>Today's Weather Forecast</h1>
            </div>
            <div class="ui-content" role="main">
                <input type="text" id="weatherSearch" value="" />
    <input type="button" id="btnGetWeather" value="Get Weather" />
    <div id="weather">
    </div>
    <!-- change this to scale. -->
    <div id="googleMap" style="width:500px;height:380px;"></div>
        <p>Today's weather forecast data will go here...</p>
                <p><a href="#fivedayforecast">View 5-day forecast</a></p>
                <p><a href="#tendayforecast">View 10-day forecast</a></p>
                
            </div>
            <div data-role="footer">
                <h2>Copyright 2016 INFSCI 1073</h2>
            </div>
        </section>

        <!-- This is the second page (in this example it is 5-day weather forecast) -->
        <section id="fivedayforecast" data-role="page">
            <div data-role="header">
                <h1>5-Day Weather Forecast</h1>
            </div>
            <div class="ui-content" role="main">
                <p>
                    5-day weather forecast data will go here...<br />
                    This is completely different from the first page you visited.<br />
                    Really!
                </p>
                <p><a href="#todayforecast">View today's forecast</a></p>
            </div>
            <div data-role="footer">
                <h2>Copyright 2016 INFSCI 1073</h2>
            </div>
        </section>
        <!-- This is the second page (in this example it is 5-day weather forecast) -->
        <section id="tendayforecast" data-role="page">
            <div data-role="header">
                <h1>10-Day Weather Forecast</h1>
            </div>
            <div class="ui-content" role="main">
                <p>
                    10-day weather forecast data will go here...<br />
                    This is completely different from the first page you visited.<br />
                    Really!
                </p>
                <p><a href="#todayforecast">View today's forecast</a></p>
            </div>
            <div data-role="footer">
                <h2>Copyright 2016 INFSCI 1073</h2>
            </div>
        </section>
    </body>

</html>
